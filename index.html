<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quant Terminal • Lot/RR</title>
<style>
  :root{
    --bg:#03060f;
    --panel: rgba(0,0,0,.38);
    --panel2: rgba(255,255,255,.03);
    --stroke: rgba(255,255,255,.10);

    --text:#dfe7ff;
    --muted:#8ea0cc;

    --g:#00ff84;          /* terminal green */
    --r:#ff3b5c;          /* terminal red */
    --c:#22d3ee;          /* cyan */
    --p:#a78bfa;          /* purple */

    --sh: 0 22px 70px rgba(0,0,0,.62);
    --rad: 18px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }

  [data-theme="light"]{
    --bg:#f5f7ff;
    --panel:#ffffff;
    --panel2:#ffffff;
    --stroke: rgba(11,18,32,.10);
    --text:#0b1220;
    --muted:#4c5976;
    --sh: 0 14px 44px rgba(11,18,32,.12);
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: var(--mono);
    color:var(--text);
    background:
      radial-gradient(1000px 600px at 15% 0%, rgba(0,255,132,.10), transparent 55%),
      radial-gradient(900px 600px at 85% 10%, rgba(255,59,92,.10), transparent 55%),
      radial-gradient(900px 600px at 55% 90%, rgba(34,211,238,.10), transparent 55%),
      var(--bg);
  }

  .wrap{max-width:1050px;margin:12px auto;padding:10px;}

  .shell{
    border:1px solid var(--stroke);
    border-radius:22px;
    background: linear-gradient(180deg,var(--panel),var(--panel2));
    box-shadow: var(--sh);
    overflow:hidden;
    position:relative;
  }
  .shell:before{
    content:"";
    position:absolute; inset:-2px;
    background: linear-gradient(135deg, rgba(0,255,132,.14), rgba(34,211,238,.12), rgba(255,59,92,.12), rgba(167,139,250,.10));
    filter: blur(18px);
    opacity:.65;
    z-index:0;
  }
  .shell > *{position:relative; z-index:1;}

  /* Top */
  .top{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:10px 12px;
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .brand{display:flex; align-items:center; gap:10px; min-width:0;}
  .mark{
    width:34px;height:34px;border-radius:14px;
    background: linear-gradient(135deg, rgba(0,255,132,.85), rgba(34,211,238,.85));
    box-shadow: 0 18px 40px rgba(0,255,132,.15);
  }
  .title{font-weight:900; font-size:12px; letter-spacing:.8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .subtitle{font-size:10px; color:var(--muted); margin-top:2px; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}

  .actions{display:flex; gap:8px; align-items:center;}
  .btn{
    border:1px solid var(--stroke);
    background: rgba(255,255,255,.06);
    color:var(--text);
    padding:8px 10px;
    border-radius:14px;
    cursor:pointer;
    font-size:11px;
    transition:.15s transform,.15s opacity;
    user-select:none;
  }
  .btn:hover{transform: translateY(-1px); opacity:.96;}

  /* Terminal board */
  .board{
    display:grid;
    grid-template-columns: 1.2fr 1fr 1fr 1fr 1fr 1fr;
    gap:8px;
    padding:10px 12px;
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  @media(max-width:980px){
    .board{grid-template-columns:1fr 1fr 1fr;}
  }
  @media(max-width:620px){
    .board{grid-template-columns:1fr 1fr;}
  }

  .tile{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    border-radius:16px;
    padding:10px 10px;
    overflow:hidden;
    position:relative;
  }
  .tile:after{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(180deg, rgba(255,255,255,.05), transparent);
    pointer-events:none;
    opacity:.55;
  }
  .tile.primary{
    background: linear-gradient(135deg, rgba(34,211,238,.10), rgba(167,139,250,.08));
  }

  .k{
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    font-size:10px;
    color:var(--muted);
    letter-spacing:.4px;
  }
  .v{
    font-size:13px;
    font-weight:900;
    margin-top:6px;
    letter-spacing:.4px;
  }
  .mini{font-size:10px; color:var(--muted); margin-top:4px;}

  .greenBox{
    background: rgba(0,255,132,.08);
    border-color: rgba(0,255,132,.22);
  }
  .redBox{
    background: rgba(255,59,92,.08);
    border-color: rgba(255,59,92,.22);
  }

  .dot{
    width:8px;height:8px;border-radius:999px;
    background: var(--muted);
    box-shadow: 0 0 0 3px rgba(255,255,255,.06);
  }
  .dot.ok{background:var(--g);}
  .dot.bad{background:var(--r);}

  /* Main compact */
  .grid{
    display:grid;
    grid-template-columns: 1.05fr .95fr;
    gap:10px;
    padding:10px 12px 12px;
  }
  @media(max-width:900px){ .grid{grid-template-columns:1fr;} }

  .card{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    border-radius:18px;
    padding:10px;
  }

  .row{display:grid; grid-template-columns:1fr 1fr; gap:8px;}
  @media(max-width:520px){ .row{grid-template-columns:1fr;} }

  label{
    display:block;
    font-size:10px;
    color:var(--muted);
    margin:7px 0 5px;
    letter-spacing:.4px;
  }

  input,select{
    width:100%;
    padding:9px 9px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.18);
    color:var(--text);
    outline:none;
    font-size:12px;
  }
  [data-theme="light"] input,[data-theme="light"] select{background:rgba(11,18,32,.03);}

  input:focus,select:focus{
    border-color: rgba(34,211,238,.40);
    box-shadow: 0 0 0 3px rgba(34,211,238,.10);
  }

  .seg{
    display:flex; gap:8px;
    padding:5px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
  }
  .seg button{
    flex:1;
    padding:8px 8px;
    border-radius:14px;
    border:1px solid transparent;
    background: transparent;
    color: var(--muted);
    cursor:pointer;
    font-size:11px;
  }
  .seg button.active{
    background: linear-gradient(135deg, rgba(34,211,238,.16), rgba(167,139,250,.14));
    border-color: rgba(255,255,255,.10);
    color: var(--text);
  }

  .kpis{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px;
  }
  .kpi{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    border-radius:16px;
    padding:10px;
  }
  .kpi.big{
    grid-column:1/-1;
    background: linear-gradient(135deg, rgba(0,255,132,.08), rgba(34,211,238,.08));
  }
  .kpi .t{font-size:10px;color:var(--muted);letter-spacing:.4px;}
  .kpi .val{font-size:14px;font-weight:950;margin-top:6px;}
  .kpi .s{font-size:10px;color:var(--muted);margin-top:4px;}

  .warn{
    border-color: rgba(255,59,92,.35) !important;
    box-shadow: 0 0 0 3px rgba(255,59,92,.10);
  }
</style>
</head>

<body data-theme="dark">
<div class="wrap">
  <div class="shell">
    <div class="top">
      <div class="brand">
        <div class="mark"></div>
        <div style="min-width:0">
          <div class="title">QUANT TERMINAL • LOT/RR • AUTO MID ENTRY</div>
          <div class="subtitle">Green/Red terminal blocks • compact • profit & risk shown</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="themeBtn">THEME</button>
        <button class="btn" id="copyBtn">COPY LOTS</button>
      </div>
    </div>

    <div class="board">
      <div class="tile primary">
        <div class="k">
          <span><span id="connDot" class="dot bad"></span> <span id="connTxt">NOT CONNECTED</span></span>
          <span class="mono" id="barPlatform">—</span>
        </div>
        <div class="v mono" id="barSymbol">—</div>
        <div class="mini">theme <span class="mono" id="barTheme">—</span> • placement <span class="mono" id="barPlacement">—</span></div>
      </div>

      <div class="tile">
        <div class="k">BID</div>
        <div class="v mono" id="barBid">—</div>
        <div class="mini">ASK <span class="mono" id="barAsk">—</span></div>
      </div>

      <div class="tile">
        <div class="k">MID (ENTRY)</div>
        <div class="v mono" id="barMid">—</div>
        <div class="mini">SPREAD <span class="mono" id="barSpr">—</span></div>
      </div>

      <div class="tile greenBox">
        <div class="k">PROFIT @ TP</div>
        <div class="v mono" id="barProfit">—</div>
        <div class="mini">TP pips <span class="mono" id="barTPp">—</span></div>
      </div>

      <div class="tile redBox">
        <div class="k">RISK $</div>
        <div class="v mono" id="barRisk">—</div>
        <div class="mini">risk/pip <span class="mono" id="barRpp">—</span></div>
      </div>

      <div class="tile">
        <div class="k">RR</div>
        <div class="v mono" id="barRR">—</div>
        <div class="mini">dir <span class="mono" id="barDir">BUY</span></div>
      </div>
    </div>

    <div class="grid">
      <!-- Inputs -->
      <div class="card">
        <div class="row">
          <div>
            <label>SYMBOL</label>
            <input id="symbol" value="EURUSD" />
          </div>
          <div>
            <label>DIRECTION</label>
            <div class="seg">
              <button id="dirBuy" class="active" type="button">BUY</button>
              <button id="dirSell" type="button">SELL</button>
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>BALANCE</label>
            <input id="balance" type="number" step="0.01" value="10000" />
          </div>
          <div>
            <label>ACCOUNT CCY</label>
            <input id="acctCcy" value="USD" />
          </div>
        </div>

        <label>RISK MODE</label>
        <div class="seg">
          <button id="modePct" class="active" type="button">RISK %</button>
          <button id="modeAmt" type="button">RISK $</button>
        </div>

        <div class="row">
          <div>
            <label id="riskLabel">RISK (%)</label>
            <input id="risk" type="number" step="0.01" value="1" />
          </div>
          <div>
            <label>SL (PIPS)</label>
            <input id="slPips" type="number" step="0.1" value="20" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>RR RATIO</label>
            <input id="rr" type="number" step="0.1" value="2" />
          </div>
          <div>
            <label>ENTRY (AUTO MID)</label>
            <input id="entry" type="number" step="0.00001" value="1.08000" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>PIP SIZE</label>
            <input id="pipSize" type="number" step="0.00001" value="0.0001" />
          </div>
          <div>
            <label>CONTRACT (UNITS/LOT)</label>
            <input id="contractSize" type="number" step="1" value="100000" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>VOLUME STEP (LOTS)</label>
            <input id="volStep" type="number" step="0.01" value="0.01" />
          </div>
          <div>
            <label>CONV RATE → ACCOUNT</label>
            <input id="convRate" type="number" step="0.0001" value="1" />
          </div>
        </div>
      </div>

      <!-- Outputs -->
      <div class="card">
        <div class="kpis">
          <div class="kpi big">
            <div class="t">RECOMMENDED LOTS</div>
            <div class="val mono" id="outLots">—</div>
            <div class="s">rounded to volume step</div>
          </div>

          <div class="kpi">
            <div class="t">MONEY AT RISK</div>
            <div class="val mono" id="outRisk">—</div>
            <div class="s" id="outRiskMode">—</div>
          </div>

          <div class="kpi">
            <div class="t">PROFIT @ TP</div>
            <div class="val mono" id="outProfit">—</div>
            <div class="s">risk × RR (approx)</div>
          </div>

          <div class="kpi">
            <div class="t">SL PRICE</div>
            <div class="val mono" id="outSL">—</div>
            <div class="s">entry ± SL move</div>
          </div>

          <div class="kpi">
            <div class="t">TP PRICE</div>
            <div class="val mono" id="outTP">—</div>
            <div class="s">entry ± TP move</div>
          </div>

          <div class="kpi">
            <div class="t">PIP VALUE / 1 LOT</div>
            <div class="val mono" id="outPipPerLot">—</div>
            <div class="s">pipSize × contract × conv</div>
          </div>

          <div class="kpi">
            <div class="t">RISK / PIP</div>
            <div class="val mono" id="outRpp">—</div>
            <div class="s">risk / SL pips</div>
          </div>

          <div class="kpi">
            <div class="t">TP PIPS</div>
            <div class="val mono" id="outTPpips">—</div>
            <div class="s">SL × RR</div>
          </div>

          <div class="kpi">
            <div class="t">UNITS</div>
            <div class="val mono" id="outUnits">—</div>
            <div class="s">contract × lots</div>
          </div>

          <div class="kpi">
            <div class="t">SPREAD COST (approx)</div>
            <div class="val mono" id="outSpreadCost">—</div>
            <div class="s">spread pips × pipValue × lots</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script type="module">
  import { createClientAdapter } from "https://esm.sh/@spotware-web-team/sdk-external-api@0.0.5";
  import {
    handleConfirmEvent,
    registerEvent,
    getAccountInformation,
    getLightSymbolList,
    getSymbol,
    subscribeQuotes,
    quoteEvent,
  } from "https://esm.sh/@spotware-web-team/sdk@0.0.9";
  import { take, tap } from "https://esm.sh/rxjs@7.8.2";

  const $ = (id) => document.getElementById(id);
  const isNum = (x) => Number.isFinite(x) && !Number.isNaN(x);

  let riskMode = "pct";   // pct|amt
  let dir = "buy";        // buy|sell
  let currentSymbolId = null;
  let lastBid = null, lastAsk = null;

  function fmt(n, d=2){
    if (!isNum(n)) return "—";
    return n.toLocaleString(undefined, { maximumFractionDigits: d });
  }
  function fmtPx(n, d=5){
    if (!isNum(n)) return "—";
    return n.toLocaleString(undefined, { maximumFractionDigits: d });
  }
  function roundStep(v, step){
    if (!isNum(v) || !isNum(step) || step <= 0) return v;
    return Math.floor(v/step) * step;
  }

  function setConn(ok){
    $("connDot").className = "dot " + (ok ? "ok" : "bad");
    $("connTxt").textContent = ok ? "CONNECTED" : "NOT CONNECTED";
  }

  function applyQueryParams(){
    const qs = new URLSearchParams(location.search);
    const theme = qs.get("theme");
    const symbol = qs.get("symbol");
    const placement = qs.get("placement");
    const platform = qs.get("platform");

    if (theme === "light" || theme === "dark") document.body.dataset.theme = theme;
    if (symbol) $("symbol").value = symbol;

    $("barSymbol").textContent = symbol || $("symbol").value || "—";
    $("barTheme").textContent = theme || "—";
    $("barPlacement").textContent = placement || "—";
    $("barPlatform").textContent = platform || "—";

    return symbol || $("symbol").value;
  }

  function setMode(mode){
    riskMode = mode;
    $("modePct").classList.toggle("active", mode==="pct");
    $("modeAmt").classList.toggle("active", mode==="amt");
    $("riskLabel").textContent = mode==="pct" ? "RISK (%)" : "RISK ($)";
    $("outRiskMode").textContent = mode==="pct" ? "balance × risk%" : "fixed amount";
    if (mode==="amt" && ($("risk").value==="" || Number($("risk").value)===1)) $("risk").value = "25";
    if (mode==="pct" && ($("risk").value==="" || Number($("risk").value)===25)) $("risk").value = "1";
    calcAll();
  }

  function setDir(newDir){
    dir = newDir;
    $("dirBuy").classList.toggle("active", dir==="buy");
    $("dirSell").classList.toggle("active", dir==="sell");
    $("barDir").textContent = dir.toUpperCase();
    calcAll();
  }

  function guessPipSize(meta, symbolName){
    const pp = meta?.pipPosition;
    if (isNum(pp)) return Math.pow(10, -pp);
    if ((symbolName||"").toUpperCase().includes("JPY")) return 0.01;
    return 0.0001;
  }

  function updateQuoteBar(){
    const bidOk = isNum(lastBid), askOk = isNum(lastAsk);
    $("barBid").textContent = bidOk ? fmtPx(lastBid, 5) : "—";
    $("barAsk").textContent = askOk ? fmtPx(lastAsk, 5) : "—";

    if (bidOk && askOk){
      const mid = (lastBid + lastAsk) / 2;
      const spr = (lastAsk - lastBid);
      $("barMid").textContent = fmtPx(mid, 5);
      $("barSpr").textContent = fmtPx(spr, 5);

      // critical: keep entry synced to live mid
      $("entry").value = mid;

      calcAll();
    }else{
      $("barMid").textContent = "—";
      $("barSpr").textContent = "—";
    }
  }

  function calcAll(){
    const balance = parseFloat($("balance").value);
    const riskIn  = parseFloat($("risk").value);
    const slPips  = parseFloat($("slPips").value);
    const rr      = parseFloat($("rr").value);

    const pipSize      = parseFloat($("pipSize").value);
    const contractSize = parseFloat($("contractSize").value);
    const convRate     = parseFloat($("convRate").value);
    const volStep      = parseFloat($("volStep").value);

    const entry = parseFloat($("entry").value);

    $("slPips").classList.toggle("warn", isNum(slPips) && slPips < 3);

    const bad = ![balance,riskIn,slPips,rr,pipSize,contractSize,convRate,volStep,entry].every(isNum) ||
                slPips<=0 || rr<=0 || pipSize<=0 || contractSize<=0 || convRate<=0;

    if (bad){
      $("outLots").textContent = "—";
      return;
    }

    const riskAmt = (riskMode==="pct") ? (balance*(riskIn/100)) : riskIn;

    // pip value per 1 lot in account currency (simple model)
    const pipPerLot = (pipSize * contractSize) * convRate;

    // lots
    const rawLots = riskAmt / (slPips * pipPerLot);
    const lots = roundStep(rawLots, volStep);
    const units = lots * contractSize;

    // TP pips and prices
    const tpPips = slPips * rr;
    const slMove = slPips * pipSize;
    const tpMove = tpPips * pipSize;

    let slPrice, tpPrice;
    if (dir==="buy"){
      slPrice = entry - slMove;
      tpPrice = entry + tpMove;
    } else {
      slPrice = entry + slMove;
      tpPrice = entry - tpMove;
    }

    // Profit estimate (RR-based): profit ≈ risk × RR
    const profitAtTp = riskAmt * rr;

    // Spread cost approximation (in account currency)
    let spreadCost = NaN;
    if (isNum(lastBid) && isNum(lastAsk)){
      const spreadPrice = (lastAsk - lastBid);
      const spreadPips = spreadPrice / pipSize;
      spreadCost = spreadPips * pipPerLot * lots;
    }

    // outputs
    $("outLots").textContent = fmt(lots, 2);
    $("outUnits").textContent = fmt(units, 0);
    $("outPipPerLot").textContent = fmt(pipPerLot, 2);
    $("outRisk").textContent = fmt(riskAmt, 2);
    $("outRpp").textContent = fmt(riskAmt/slPips, 2);
    $("outSL").textContent = fmtPx(slPrice, 5);
    $("outTP").textContent = fmtPx(tpPrice, 5);
    $("outTPpips").textContent = fmt(tpPips, 1);
    $("outProfit").textContent = fmt(profitAtTp, 2);
    $("outSpreadCost").textContent = isNum(spreadCost) ? fmt(spreadCost, 2) : "—";

    // board stats
    $("barRisk").textContent = (riskMode==="pct") ? `${fmt(riskAmt,2)}` : `${fmt(riskAmt,2)}`;
    $("barRpp").textContent = fmt(riskAmt/slPips, 2);
    $("barRR").textContent = fmt(rr, 2);
    $("barTPp").textContent = fmt(tpPips, 1);
    $("barProfit").textContent = fmt(profitAtTp, 2);
  }

  async function connectSDKAndAutofill(symbolName){
    const adapter = createClientAdapter({ logger: undefined });

    handleConfirmEvent(adapter, {}).pipe(take(1)).subscribe();
    await new Promise((resolve) => {
      registerEvent(adapter).pipe(
        take(1),
        tap(() => {
          handleConfirmEvent(adapter, {}).pipe(take(1)).subscribe();
          setConn(true);
          resolve();
        })
      ).subscribe();
    });

    getAccountInformation(adapter, {}).pipe(take(1)).subscribe({
      next: (info) => {
        const ccy = info?.accountCurrency || info?.currency || info?.baseCurrency;
        const bal = info?.balance ?? info?.Balance;
        if (ccy) $("acctCcy").value = String(ccy);
        if (isNum(bal)) $("balance").value = Number(bal);
        calcAll();
      },
      error: () => {}
    });

    const light = await new Promise((resolve) => {
      getLightSymbolList(adapter, {}).pipe(take(1)).subscribe({ next: resolve, error: () => resolve(null) });
    });

    const list = light?.symbol ?? light?.symbols ?? light?.symbolList ?? [];
    const wanted = (symbolName || "").toUpperCase();

    const hit = Array.isArray(list)
      ? list.find(s => String(s?.name || s?.symbolName || "").toUpperCase() === wanted)
      : null;

    currentSymbolId = hit?.id ?? hit?.symbolId ?? null;
    if (!currentSymbolId) return;

    const sym = await new Promise((resolve) => {
      getSymbol(adapter, { symbolId: [currentSymbolId] }).pipe(take(1)).subscribe({ next: resolve, error: () => resolve(null) });
    });
    const meta = Array.isArray(sym?.symbol) ? sym.symbol[0] : (sym?.symbol || sym);

    if (meta){
      const lotSize = meta?.lotSize ?? meta?.lotSizeInUnits ?? meta?.contractSize;
      const stepVol = meta?.stepVolume ?? meta?.minVolumeStep ?? meta?.volumeStep;
      if (isNum(lotSize)) $("contractSize").value = Number(lotSize);
      if (isNum(stepVol) && isNum(lotSize) && lotSize>0) $("volStep").value = Number(stepVol) / Number(lotSize);
      $("pipSize").value = guessPipSize(meta, wanted);
      calcAll();
    }

    subscribeQuotes(adapter, { symbolId: [currentSymbolId] }).pipe(take(1)).subscribe({ next:()=>{}, error:()=>{} });

    quoteEvent(adapter).subscribe({
      next: (q) => {
        const sid = q?.symbolId ?? q?.SymbolId ?? q?.symbol?.id ?? q?.symbol?.symbolId;
        if (isNum(sid) && isNum(currentSymbolId) && Number(sid) !== Number(currentSymbolId)) return;

        const bid = q?.bid ?? q?.Bid ?? q?.priceBid ?? q?.bidPrice;
        const ask = q?.ask ?? q?.Ask ?? q?.priceAsk ?? q?.askPrice;

        if (isNum(bid)) lastBid = Number(bid);
        if (isNum(ask)) lastAsk = Number(ask);

        updateQuoteBar();
      }
    });
  }

  // UI events
  $("themeBtn").addEventListener("click", ()=> {
    document.body.dataset.theme = (document.body.dataset.theme==="dark") ? "light" : "dark";
  });

  $("copyBtn").addEventListener("click", async ()=> {
    const txt = $("outLots").textContent;
    if (!txt || txt==="—") return;
    try{
      await navigator.clipboard.writeText(txt);
      $("copyBtn").textContent="COPIED";
      setTimeout(()=> $("copyBtn").textContent="COPY LOTS", 900);
    }catch{}
  });

  $("modePct").addEventListener("click", ()=> setMode("pct"));
  $("modeAmt").addEventListener("click", ()=> setMode("amt"));
  $("dirBuy").addEventListener("click", ()=> setDir("buy"));
  $("dirSell").addEventListener("click", ()=> setDir("sell"));

  ["symbol","balance","acctCcy","risk","slPips","rr","entry","pipSize","contractSize","volStep","convRate"]
    .forEach(id => $(id).addEventListener("input", calcAll));

  // boot
  const sym = applyQueryParams();
  setMode("pct");
  setDir("buy");
  calcAll();

  try{ await connectSDKAndAutofill(sym); } catch(e){ setConn(false); }
</script>
</body>
</html>
