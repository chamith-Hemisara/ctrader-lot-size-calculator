<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quant Terminal • Lot + RR</title>
<style>
  :root{
    --bg:#050713;
    --panel: rgba(255,255,255,.06);
    --panel2: rgba(255,255,255,.03);
    --stroke: rgba(255,255,255,.12);
    --text:#eaf0ff;
    --muted:#93a4cc;

    --c1:#22d3ee;     /* cyan */
    --c2:#a78bfa;     /* purple */
    --c3:#34d399;     /* green */
    --c4:#fb7185;     /* red */

    --r:18px;
    --sh: 0 22px 70px rgba(0,0,0,.55);
  }

  [data-theme="light"]{
    --bg:#f6f7ff;
    --panel:#ffffff;
    --panel2:#ffffff;
    --stroke: rgba(11,18,32,.10);
    --text:#0b1220;
    --muted:#4c5976;
    --sh: 0 14px 44px rgba(11,18,32,.12);
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    color:var(--text);
    background:
      radial-gradient(1200px 700px at 15% 0%, rgba(34,211,238,.12), transparent 55%),
      radial-gradient(900px 600px at 85% 10%, rgba(167,139,250,.12), transparent 55%),
      radial-gradient(900px 600px at 50% 90%, rgba(52,211,153,.10), transparent 55%),
      var(--bg);
  }

  .wrap{max-width:1020px;margin:14px auto;padding:12px;}

  .shell{
    border:1px solid var(--stroke);
    border-radius:24px;
    background: linear-gradient(180deg,var(--panel),var(--panel2));
    box-shadow: var(--sh);
    overflow:hidden;
    position:relative;
  }
  .shell:before{
    content:"";
    position:absolute; inset:-2px;
    background: linear-gradient(135deg, rgba(34,211,238,.20), rgba(167,139,250,.16), rgba(52,211,153,.14));
    filter: blur(18px);
    opacity:.65;
    z-index:0;
  }
  .shell > *{position:relative; z-index:1;}

  /* Top bar */
  .top{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:12px 14px;
    border-bottom:1px solid rgba(255,255,255,.08);
    backdrop-filter: blur(10px);
  }
  .brand{display:flex;align-items:center;gap:12px;min-width:0;}
  .mark{
    width:40px;height:40px;border-radius:16px;
    background: linear-gradient(135deg, rgba(34,211,238,.85), rgba(167,139,250,.85));
    box-shadow: 0 18px 50px rgba(34,211,238,.18);
  }
  .title{font-weight:950; font-size:14px; letter-spacing:.4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .subtitle{font-size:11px; color:var(--muted); margin-top:2px;}

  .actions{display:flex;gap:8px;align-items:center;}
  .btn{
    border:1px solid var(--stroke);
    background: rgba(255,255,255,.06);
    color:var(--text);
    padding:9px 11px;
    border-radius:14px;
    cursor:pointer;
    font-size:12px;
    transition:.15s transform,.15s opacity;
    user-select:none;
  }
  .btn:hover{transform: translateY(-1px); opacity:.96;}

  /* Stat strip */
  .strip{
    display:grid;
    grid-template-columns: 1.3fr 1fr 1fr 1fr 1fr;
    gap:10px;
    padding:12px 14px;
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  @media(max-width:920px){
    .strip{grid-template-columns:1fr 1fr; }
  }
  .stat{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    border-radius:18px;
    padding:10px 12px;
    overflow:hidden;
  }
  .stat.primary{
    background: linear-gradient(135deg, rgba(34,211,238,.12), rgba(167,139,250,.10));
  }
  .k{font-size:11px;color:var(--muted); display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .v{font-size:15px;font-weight:950;margin-top:6px;}
  .mini{font-size:11px;color:var(--muted);margin-top:4px;}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

  .dot{
    width:8px;height:8px;border-radius:999px; background:var(--muted);
    box-shadow: 0 0 0 3px rgba(255,255,255,.06);
  }
  .dot.ok{background:var(--c3);}
  .dot.bad{background:var(--c4);}

  /* Main grid (compact) */
  .grid{
    display:grid;
    grid-template-columns: 1.05fr .95fr;
    gap:12px;
    padding:12px 14px 14px;
  }
  @media(max-width:900px){ .grid{grid-template-columns:1fr;} }

  .card{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    border-radius:20px;
    padding:12px;
  }

  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
  @media(max-width:520px){ .row{grid-template-columns:1fr;} }

  label{display:block;font-size:11px;color:var(--muted); margin:8px 0 6px;}
  input,select{
    width:100%;
    padding:10px 10px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.16);
    color:var(--text);
    outline:none;
    font-size:13px;
  }
  [data-theme="light"] input,[data-theme="light"] select{background:rgba(11,18,32,.03);}

  input:focus,select:focus{
    border-color: rgba(34,211,238,.45);
    box-shadow: 0 0 0 3px rgba(34,211,238,.10);
  }

  .seg{
    display:flex; gap:8px;
    padding:6px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
  }
  .seg button{
    flex:1; padding:9px 10px;
    border-radius:14px;
    border:1px solid transparent;
    background: transparent;
    color: var(--muted);
    cursor:pointer;
    font-size:12px;
  }
  .seg button.active{
    background: linear-gradient(135deg, rgba(34,211,238,.18), rgba(167,139,250,.16));
    border-color: rgba(255,255,255,.10);
    color: var(--text);
  }

  .kpis{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  .kpi{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    border-radius:18px;
    padding:12px;
  }
  .kpi.big{
    grid-column:1 / -1;
    background: linear-gradient(135deg, rgba(52,211,153,.10), rgba(34,211,238,.10));
  }
  .kpi .t{font-size:11px;color:var(--muted);}
  .kpi .val{font-size:18px;font-weight:950;margin-top:6px;}
  .kpi .s{font-size:11px;color:var(--muted);margin-top:4px;}

  .warn{
    border-color: rgba(251,113,133,.35) !important;
    box-shadow: 0 0 0 3px rgba(251,113,133,.10);
  }
</style>
</head>

<body data-theme="dark">
<div class="wrap">
  <div class="shell">
    <div class="top">
      <div class="brand">
        <div class="mark"></div>
        <div style="min-width:0">
          <div class="title">QUANT TERMINAL • Lot Size + RR</div>
          <div class="subtitle">Symbol auto-fill • Live mid-entry • Compact stats</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="themeBtn">Theme</button>
        <button class="btn" id="copyBtn">Copy lots</button>
      </div>
    </div>

    <div class="strip">
      <div class="stat primary">
        <div class="k">
          <span><span id="connDot" class="dot bad"></span> <span id="connTxt">Not connected</span></span>
          <span class="mono" id="barPlatform">—</span>
        </div>
        <div class="v mono" id="barSymbol">—</div>
        <div class="mini">theme: <span class="mono" id="barTheme">—</span> • placement: <span class="mono" id="barPlacement">—</span></div>
      </div>

      <div class="stat">
        <div class="k">BID <span class="mono">tick</span></div>
        <div class="v mono" id="barBid">—</div>
        <div class="mini">ASK <span class="mono" id="barAskMini">—</span></div>
      </div>

      <div class="stat">
        <div class="k">MID <span class="mono">entry</span></div>
        <div class="v mono" id="barMid">—</div>
        <div class="mini">spread <span class="mono" id="barSpr">—</span></div>
      </div>

      <div class="stat">
        <div class="k">RISK <span class="mono">mode</span></div>
        <div class="v mono" id="barRisk">—</div>
        <div class="mini">risk/pip <span class="mono" id="barRpp">—</span></div>
      </div>

      <div class="stat">
        <div class="k">RR <span class="mono">TP:SL</span></div>
        <div class="v mono" id="barRR">—</div>
        <div class="mini">TP pips <span class="mono" id="barTPp">—</span></div>
      </div>
    </div>

    <div class="grid">
      <!-- Inputs (compact) -->
      <div class="card">
        <div class="row">
          <div>
            <label>Symbol (auto)</label>
            <input id="symbol" value="EURUSD" />
          </div>
          <div>
            <label>Direction</label>
            <div class="seg">
              <button id="dirBuy" class="active" type="button">BUY</button>
              <button id="dirSell" type="button">SELL</button>
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Balance</label>
            <input id="balance" type="number" step="0.01" value="10000" />
          </div>
          <div>
            <label>Account currency</label>
            <input id="acctCcy" value="USD" />
          </div>
        </div>

        <label>Risk mode</label>
        <div class="seg">
          <button id="modePct" class="active" type="button">Risk %</button>
          <button id="modeAmt" type="button">Risk $</button>
        </div>

        <div class="row">
          <div>
            <label id="riskLabel">Risk (%)</label>
            <input id="risk" type="number" step="0.01" value="1" />
          </div>
          <div>
            <label>Stop-loss (pips)</label>
            <input id="slPips" type="number" step="0.1" value="20" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>RR ratio</label>
            <input id="rr" type="number" step="0.1" value="2" />
          </div>
          <div>
            <label>Entry (auto mid)</label>
            <input id="entry" type="number" step="0.00001" value="1.08000" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Pip size</label>
            <input id="pipSize" type="number" step="0.00001" value="0.0001" />
          </div>
          <div>
            <label>Contract size (units/lot)</label>
            <input id="contractSize" type="number" step="1" value="100000" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Volume step (lots)</label>
            <input id="volStep" type="number" step="0.01" value="0.01" />
          </div>
          <div>
            <label>Conversion rate → account</label>
            <input id="convRate" type="number" step="0.0001" value="1" />
          </div>
        </div>
      </div>

      <!-- Outputs (stats) -->
      <div class="card">
        <div class="kpis">
          <div class="kpi big">
            <div class="t">Recommended lots</div>
            <div class="val mono" id="outLots">—</div>
            <div class="s">rounded to volume step</div>
          </div>

          <div class="kpi">
            <div class="t">SL price</div>
            <div class="val mono" id="outSL">—</div>
            <div class="s">based on entry + SL pips</div>
          </div>

          <div class="kpi">
            <div class="t">TP price</div>
            <div class="val mono" id="outTP">—</div>
            <div class="s">based on RR</div>
          </div>

          <div class="kpi">
            <div class="t">Units</div>
            <div class="val mono" id="outUnits">—</div>
            <div class="s">contract × lots</div>
          </div>

          <div class="kpi">
            <div class="t">Pip value / 1 lot</div>
            <div class="val mono" id="outPipPerLot">—</div>
            <div class="s">× conversion rate</div>
          </div>

          <div class="kpi">
            <div class="t">Total risk</div>
            <div class="val mono" id="outRisk">—</div>
            <div class="s" id="outRiskMode">—</div>
          </div>

          <div class="kpi">
            <div class="t">Risk per pip</div>
            <div class="val mono" id="outRpp">—</div>
            <div class="s">risk / SL pips</div>
          </div>

          <div class="kpi">
            <div class="t">TP pips</div>
            <div class="val mono" id="outTPpips">—</div>
            <div class="s">SL pips × RR</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script type="module">
  // CDN imports. If cTrader updates, change versions here only.
  import { createClientAdapter } from "https://esm.sh/@spotware-web-team/sdk-external-api@0.0.5";
  import {
    handleConfirmEvent,
    registerEvent,
    getAccountInformation,
    getLightSymbolList,
    getSymbol,
    subscribeQuotes,
    quoteEvent,
  } from "https://esm.sh/@spotware-web-team/sdk@0.0.9";
  import { take, tap } from "https://esm.sh/rxjs@7.8.2";

  const $ = (id) => document.getElementById(id);
  const isNum = (x) => Number.isFinite(x) && !Number.isNaN(x);

  let riskMode = "pct";   // pct|amt
  let dir = "buy";        // buy|sell
  let currentSymbolId = null;
  let lastBid = null, lastAsk = null;

  function fmt(n, d=5){
    if (!isNum(n)) return "—";
    return n.toLocaleString(undefined, { maximumFractionDigits: d });
  }
  function roundStep(v, step){
    if (!isNum(v) || !isNum(step) || step <= 0) return v;
    return Math.floor(v/step) * step;
  }
  function setConn(ok){
    $("connDot").className = "dot " + (ok ? "ok" : "bad");
    $("connTxt").textContent = ok ? "Connected" : "Not connected";
  }

  function applyQueryParams(){
    const qs = new URLSearchParams(location.search);
    const theme = qs.get("theme");
    const symbol = qs.get("symbol");
    const placement = qs.get("placement");
    const platform = qs.get("platform");

    if (theme === "light" || theme === "dark") document.body.dataset.theme = theme;
    if (symbol) $("symbol").value = symbol;

    $("barSymbol").textContent = symbol || $("symbol").value || "—";
    $("barTheme").textContent = theme || "—";
    $("barPlacement").textContent = placement || "—";
    $("barPlatform").textContent = platform || "—";

    return symbol || $("symbol").value;
  }

  function setMode(mode){
    riskMode = mode;
    $("modePct").classList.toggle("active", mode==="pct");
    $("modeAmt").classList.toggle("active", mode==="amt");
    $("riskLabel").textContent = mode==="pct" ? "Risk (%)" : "Risk ($)";
    $("outRiskMode").textContent = mode==="pct" ? "balance × risk%" : "fixed amount";
    if (mode==="amt" && ($("risk").value==="" || Number($("risk").value)===1)) $("risk").value = "25";
    if (mode==="pct" && ($("risk").value==="" || Number($("risk").value)===25)) $("risk").value = "1";
    calcAll();
  }

  function setDir(newDir){
    dir = newDir;
    $("dirBuy").classList.toggle("active", dir==="buy");
    $("dirSell").classList.toggle("active", dir==="sell");
    calcAll();
  }

  function guessPipSize(meta, symbolName){
    const pp = meta?.pipPosition;
    if (isNum(pp)) return Math.pow(10, -pp);
    if ((symbolName||"").toUpperCase().includes("JPY")) return 0.01;
    return 0.0001;
  }

  function updateQuoteBar(){
    $("barBid").textContent = isNum(lastBid) ? fmt(lastBid, 5) : "—";
    $("barAskMini").textContent = isNum(lastAsk) ? fmt(lastAsk, 5) : "—";

    if (isNum(lastBid) && isNum(lastAsk)){
      const mid = (lastBid + lastAsk) / 2;
      $("barMid").textContent = fmt(mid, 5);
      $("barAsk").textContent = fmt(lastAsk, 5);
      $("barSpr").textContent = fmt(lastAsk - lastBid, 5);

      // Critical fix: RR uses CURRENT price
      $("entry").value = mid;

      calcAll();
    }else{
      $("barMid").textContent = "—";
      $("barAsk").textContent = "—";
      $("barSpr").textContent = "—";
    }
  }

  function calcAll(){
    const balance = parseFloat($("balance").value);
    const riskIn  = parseFloat($("risk").value);
    const slPips  = parseFloat($("slPips").value);
    const rr      = parseFloat($("rr").value);

    const pipSize      = parseFloat($("pipSize").value);
    const contractSize = parseFloat($("contractSize").value);
    const convRate     = parseFloat($("convRate").value);
    const volStep      = parseFloat($("volStep").value);

    const entry = parseFloat($("entry").value);

    // simple validation + compact “red” highlight
    const bad = ![balance,riskIn,slPips,rr,pipSize,contractSize,convRate,volStep,entry].every(isNum) || slPips<=0 || rr<=0 || pipSize<=0 || contractSize<=0 || convRate<=0;
    $("slPips").classList.toggle("warn", isNum(slPips) && slPips < 3); // too small SL highlight

    if (bad){
      $("outLots").textContent = "—";
      return;
    }

    const riskAmt = (riskMode==="pct") ? (balance*(riskIn/100)) : riskIn;

    // pip value per 1 lot (simple)
    const pipPerLot = (pipSize * contractSize) * convRate;

    const rawLots = riskAmt / (slPips * pipPerLot);
    const lots = roundStep(rawLots, volStep);
    const units = lots * contractSize;

    const tpPips = slPips * rr;
    const slMove = slPips * pipSize;
    const tpMove = tpPips * pipSize;

    let slPrice, tpPrice;
    if (dir==="buy"){
      slPrice = entry - slMove;
      tpPrice = entry + tpMove;
    } else {
      slPrice = entry + slMove;
      tpPrice = entry - tpMove;
    }

    // outputs
    $("outLots").textContent = fmt(lots, 2);
    $("outUnits").textContent = fmt(units, 0);
    $("outPipPerLot").textContent = fmt(pipPerLot, 2);
    $("outRisk").textContent = fmt(riskAmt, 2);
    $("outRpp").textContent = fmt(riskAmt/slPips, 2);
    $("outSL").textContent = fmt(slPrice, 5);
    $("outTP").textContent = fmt(tpPrice, 5);
    $("outTPpips").textContent = fmt(tpPips, 1);

    // top “terminal stats”
    $("barRisk").textContent = (riskMode==="pct")
      ? `${fmt(riskIn,2)}% → ${fmt(riskAmt,2)}`
      : `$${fmt(riskAmt,2)}`;
    $("barRpp").textContent = fmt(riskAmt/slPips, 2);
    $("barRR").textContent = fmt(rr, 2);
    $("barTPp").textContent = fmt(tpPips, 1);
  }

  async function connectSDKAndAutofill(symbolName){
    const adapter = createClientAdapter({ logger: undefined });

    // handshake
    handleConfirmEvent(adapter, {}).pipe(take(1)).subscribe();
    await new Promise((resolve) => {
      registerEvent(adapter).pipe(
        take(1),
        tap(() => {
          handleConfirmEvent(adapter, {}).pipe(take(1)).subscribe();
          setConn(true);
          resolve();
        })
      ).subscribe();
    });

    // account info
    getAccountInformation(adapter, {}).pipe(take(1)).subscribe({
      next: (info) => {
        const ccy = info?.accountCurrency || info?.currency || info?.baseCurrency;
        const bal = info?.balance ?? info?.Balance;
        if (ccy) $("acctCcy").value = String(ccy);
        if (isNum(bal)) $("balance").value = Number(bal);
        calcAll();
      },
      error: () => {}
    });

    // resolve symbolId
    const light = await new Promise((resolve) => {
      getLightSymbolList(adapter, {}).pipe(take(1)).subscribe({ next: resolve, error: () => resolve(null) });
    });

    const list = light?.symbol ?? light?.symbols ?? light?.symbolList ?? [];
    const wanted = (symbolName || "").toUpperCase();

    const hit = Array.isArray(list)
      ? list.find(s => String(s?.name || s?.symbolName || "").toUpperCase() === wanted)
      : null;

    currentSymbolId = hit?.id ?? hit?.symbolId ?? null;
    if (!currentSymbolId) return;

    // symbol details
    const sym = await new Promise((resolve) => {
      getSymbol(adapter, { symbolId: [currentSymbolId] }).pipe(take(1)).subscribe({ next: resolve, error: () => resolve(null) });
    });
    const meta = Array.isArray(sym?.symbol) ? sym.symbol[0] : (sym?.symbol || sym);

    if (meta){
      const lotSize = meta?.lotSize ?? meta?.lotSizeInUnits ?? meta?.contractSize;
      const stepVol = meta?.stepVolume ?? meta?.minVolumeStep ?? meta?.volumeStep;

      if (isNum(lotSize)) $("contractSize").value = Number(lotSize);
      if (isNum(stepVol) && isNum(lotSize) && lotSize>0) $("volStep").value = Number(stepVol) / Number(lotSize);
      $("pipSize").value = guessPipSize(meta, wanted);
      calcAll();
    }

    // quotes
    subscribeQuotes(adapter, { symbolId: [currentSymbolId] }).pipe(take(1)).subscribe({ next:()=>{}, error:()=>{} });

    quoteEvent(adapter).subscribe({
      next: (q) => {
        const sid = q?.symbolId ?? q?.SymbolId ?? q?.symbol?.id ?? q?.symbol?.symbolId;
        if (isNum(sid) && isNum(currentSymbolId) && Number(sid) !== Number(currentSymbolId)) return;

        const bid = q?.bid ?? q?.Bid ?? q?.priceBid ?? q?.bidPrice;
        const ask = q?.ask ?? q?.Ask ?? q?.priceAsk ?? q?.askPrice;

        if (isNum(bid)) lastBid = Number(bid);
        if (isNum(ask)) lastAsk = Number(ask);

        updateQuoteBar();
      }
    });
  }

  // UI events
  $("themeBtn").addEventListener("click", ()=> {
    document.body.dataset.theme = (document.body.dataset.theme==="dark") ? "light" : "dark";
  });

  $("copyBtn").addEventListener("click", async ()=> {
    const txt = $("outLots").textContent;
    if (!txt || txt==="—") return;
    try{
      await navigator.clipboard.writeText(txt);
      $("copyBtn").textContent="Copied!";
      setTimeout(()=> $("copyBtn").textContent="Copy lots", 900);
    }catch{}
  });

  $("modePct").addEventListener("click", ()=> setMode("pct"));
  $("modeAmt").addEventListener("click", ()=> setMode("amt"));
  $("dirBuy").addEventListener("click", ()=> setDir("buy"));
  $("dirSell").addEventListener("click", ()=> setDir("sell"));

  ["symbol","balance","acctCcy","risk","slPips","rr","entry","pipSize","contractSize","volStep","convRate"]
    .forEach(id => $(id).addEventListener("input", calcAll));

  // boot
  const sym = applyQueryParams();
  setMode("pct");
  calcAll();

  try{ await connectSDKAndAutofill(sym); } catch(e){ setConn(false); }
</script>
</body>
</html>
